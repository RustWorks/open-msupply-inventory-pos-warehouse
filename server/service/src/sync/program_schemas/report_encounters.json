{
  "index": {
    "template": "template.html",
    "header": null,
    "footer": null,
    "query": "query.graphql"
  },
  "entries": {
    "query.graphql": {
      "type": "GraphGLQuery",
      "data": {
        "query": "query ListOfAppointments(\n  $storeId: String\n  $startDatetime: String!\n  $endDatetime: String!\n  $status: String\n) {\n  store(id: $storeId) {\n    ... on StoreNode {\n      storeName\n      logo\n    }\n  }\n  encounters(\n    storeId: $storeId\n    sort: { key: startDatetime, desc: true }\n    filter: {\n      program: { equalTo: \"HIVCareProgram\" }\n      status: { equalTo: $status }\n      startDatetime: {\n        afterOrEqualTo: $startDatetime\n        beforeOrEqualTo: $endDatetime\n      }\n    }\n  ) {\n    ... on EncounterConnector {\n      nodes {\n        events(\n          at: $endDatetime\n          filter: { type: { equalAny: [\"viralLoadResultDatetime\"] } }\n        ) {\n          type\n          data\n        }\n        createdDatetime\n        startDatetime\n        patient {\n          name\n          id\n          dateOfBirth\n          gender\n          phone\n        }\n        status\n        programEnrolment {\n          programEnrolmentId\n        }\n      }\n      totalCount\n    }\n  }\n  completedEncounters: encounters(\n    storeId: $storeId\n    sort: { key: startDatetime, desc: true }\n    filter: {\n      program: { equalTo: \"HIVCareProgram\" }\n      status: { equalTo: \"COMPLETED\" }\n      startDatetime: {\n        afterOrEqualTo: $startDatetime\n        beforeOrEqualTo: $endDatetime\n      }\n    }\n  ) {\n    ... on EncounterConnector {\n      totalCount\n    }\n  }\n}\n",
        "variables": null
      }
    },
    "template.html": {
      "type": "TeraTemplate",
      "data": {
        "output": "Html",
        "template": "{% set_global timezone = \"Pacific/Port_Moresby\" %}\n\n<style>\n  {% include \"style.css\" %}\n</style>\n\n<body>\n  <h1>{{data.store.storeName}}</h1>\n  <h2>Appointments for period</h2>\n  <h2>\n    {{arguments.startDatetime |\n    date(format=\"%d-%b-%y\",timezone=timezone)}} to {{arguments.endDatetime |\n    date(format=\"%d-%b-%y\",timezone=timezone)}}\n  </h2>\n \n  {% if data.store.logo %}\n  <div class=\"store-logo-container\">\n  <img class=\"logo\" id='store-logo' src='{{data.store.logo}}' />\n  </div>\n  {% endif %}\n\n  <div class=\"container\">\n  <table>\n    <thead>\n      <tr class=\"heading\">\n        <td>Appointment Date</td>\n        <td>Patient ID</td>\n        <td>Name</td>\n        <td>Date of Birth</td>\n        <td>Sex</td>\n        <td>Date appointment made</td>\n        <td>Cancelled</td>\n        <td>Visited</td>\n        <td>Num Month Since Last VL</td>\n        <td>Need VL?</td>\n        <td>Contact</td>\n      </tr>\n    </thead>\n    <tbody>\n    {% for encounter in data.encounters.nodes %}\n    <tr>\n      <td>\n        {{encounter.startDatetime | date(format=\"%d-%b-%y\",timezone=timezone)}}\n      </td>\n      <td>{{encounter.programEnrolment.programEnrolmentId}}</td>\n      <td>{{encounter.patient.name}}</td>\n      <td>{{encounter.patient.dateOfBirth | date(format=\"%d-%b-%y\")}}</td>\n      <td>\n        {% if encounter.patient.gender == \"FEMALE\" %}\n          Female\n        {% elif encounter.patient.gender == \"MALE\" %}\n          Male\n        {% elif encounter.patient.gender == \"TRANSGENDER\" %}\n          Transgender\n        {% else %}\n          {{encounter.patient.gender}}\n        {% endif %}\n      </td>\n      <td>\n        {{encounter.createdDatetime |\n        date(format=\"%d-%b-%y\",timezone=timezone)}}\n      </td>\n      <td>\n        {% if encounter.status == \"CANCELLED\" %}\n      true\n        {% endif %}\n      </td>\n      <td>{% if encounter.status == \"COMPLETED\" %}\n        true\n          {% endif %}\n      </td>\n        {% set viralLoadDatetime = encounter.events | filter(attribute=\"type\", value=\"viralLoadResultDatetime\") | map(attribute=\"data\") %}\n        {% if viralLoadDatetime[0] %}\n          {% set viralLoadDatetimeSec = viralLoadDatetime[0] | date(format=\"%s\") | int %}\n          {% set nowSec = now() | date(format=\"%s\") | int %}\n          {% set monthTimes10 = (nowSec - viralLoadDatetimeSec) / 2592000 * 10 | int %}\n          {% set monthSinceVL = monthTimes10 / 10%}\n          <td>{{monthSinceVL}}</td>\n          <td>\n            {% if monthSinceVL > 12 %}\n            ANNUAL\n            {% endif %}\n          </td>\n        {% else %}\n          <td></td>\n          <td></td>\n        {% endif %}\n      <td>{{encounter.patient.phone}}</td>\n    </tr>\n    {% endfor %}\n    </tbody>\n  </table>\n\n  <div class=\"summary-row\">\n    <div class=\"label\">Number of appointments for period:</div>\n    <div class=\"value\">{{data.encounters.totalCount}}</div>\n  </div>\n  <div class=\"summary-row\">\n    <div class=\"label\">Number of appointments where patient visited:</div>\n    <div class=\"value\">{{data.completedEncounters.totalCount}}</div>\n  </div>\n\n  </div>\n</body>\n"
      }
    },
    "style.css": {
      "type": "Resource",
      "data": "@page {\n  margin: 0;\n  size: A4 landscape;\n}\n\nh1 {\n  width: fit-content;\n  margin: 7 auto;\n  padding: 0px 30px;\n  border: 2px solid black;\n  box-shadow: 5px 5px 0px black;\n  font-size: 15px;\n  margin-bottom: 10px;\n}\n\nh2 {\n  width: fit-content;\n  margin: 5 auto;\n  font-size: 15px;\n}\n\n.store-logo-container {\n  position: absolute;\n  top: 5;\n  right: 30;\n}\n\n.store-logo-container .logo {\n  display: block;\n  width: 70px;\n  height: 70px;\n}\n\n.container {\n  max-width: 1000px;\n  margin: auto;\n  padding: 10px;\n  border-top: 2px solid black;\n  font-size: 12px;\n  font-family: \"Helvetica Neue\", \"Helvetica\", Helvetica, Arial, sans-serif;\n  color: #555;\n}\n\n.container table {\n  width: 100%;\n  font-size: inherit;\n  font-family: inherit;\n  text-align: left;\n  margin-top: 10;\n  margin-bottom: 15;\n}\n\n.container table td {\n  padding: 5px;\n  vertical-align: top;\n}\n\n.container table tr.heading td {\n  font-weight: bold;\n  margin-bottom: 15px;\n}\n\n.summary-row {\n  width: 100%;\n  display: flex;\n  justify-content: flex-end;\n  font-weight: bold;\n  text-align: end;\n  margin-bottom: 3;\n}\n\n.summary-row .value {\n  min-width: 100;\n}\n"
    }
  }
}
